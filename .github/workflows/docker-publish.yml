name: publish

on:
  push:
    branches:
      - main

jobs:

  publish-tijdvoorhetkarretje-docker-image:
    runs-on: ubuntu-latest

    permissions:
      contents: read
      packages: write

    steps:

    - uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Login to GitHub Container Registry
      uses: docker/login-action@v3
      with:
        registry: ghcr.io
        username: ${{ github.actor }}
        password: ${{ secrets.github_token }}

    - name: Bereken de belachelijke tags
      run: |
        SHORT_SHA=$(git rev-parse --short HEAD)
        COMMIT_COUNT=$(git rev-list --count HEAD)

        DAY_NL=(zondag maandag dinsdag woensdag donderdag vrijdag zaterdag)
        TODAY_NL=${DAY_NL[$(date +%w)]}
        DUTCH_TIME=$(date +%Hu%M)

        CALVER=$(date +%Y).$(date +%V).$COMMIT_COUNT

        EXCLAMATIONS=(verdorie potjandorie jeetje bliksems tjongejonge)
        EXCL=${EXCLAMATIONS[$((COMMIT_COUNT % 5))]}

        IMAGE=ghcr.io/smandersrockstars/ishettijdvoorhetkarretje-web

        echo "SHORT_SHA=$SHORT_SHA"           >> $GITHUB_ENV
        echo "COMMIT_COUNT=$COMMIT_COUNT"     >> $GITHUB_ENV
        echo "TODAY_NL=$TODAY_NL"             >> $GITHUB_ENV
        echo "DUTCH_TIME=$DUTCH_TIME"         >> $GITHUB_ENV
        echo "CALVER=$CALVER"                 >> $GITHUB_ENV
        echo "EXCL=$EXCL"                     >> $GITHUB_ENV
        echo "IMAGE=$IMAGE"                   >> $GITHUB_ENV

    - name: Bouw en push met belachelijke tags
      run: |
        docker build . \
          --tag $IMAGE:latest \
          --tag $IMAGE:$SHORT_SHA \
          --tag $IMAGE:karretje-$COMMIT_COUNT \
          --tag $IMAGE:$TODAY_NL-$DUTCH_TIME \
          --tag $IMAGE:$CALVER \
          --tag $IMAGE:$EXCL

        docker push $IMAGE --all-tags
